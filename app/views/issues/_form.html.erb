<%= form_with(model: issue.persisted? ? issue : [issue.project || @project, issue], class: "space-y-8 rounded-sm") do |form| %>
  <% if issue.errors.any? %>
    <div id="error_explanation" class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-sm shadow-md">
      <h2 class="font-bold mb-3"><%= pluralize(issue.errors.count, "error") %> prevented this issue from being saved:</h2>
      <ul class="list-disc pl-6 space-y-1">
        <% issue.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <% if issue.project_id.present? %>
      <%= form.hidden_field :project_id %>
      <div>
        <%= form.label :project_id, "Project Name", class: "block text-sm font-semibold text-gray-700" %>
        <p class="mt-2 w-full rounded-sm font-bold text-md px-4 py-2 bg-gray-100 text-gray-700 shadow-inner">
          <%= Project.find(issue.project_id).title %>
        </p>
      </div>
    <% else %>
      <div>
        <%= form.label :project_id, "Project", class: "block text-sm font-semibold text-gray-700" %>
        <%= form.collection_select :project_id, Project.all, :id, :name,
          { prompt: "Select a project" },
          { class: "mt-2 block w-full rounded-sm border px-4 py-2 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition #{issue.errors[:project_id].any? ? 'border-red-500' : 'border-gray-300'}" } %>
      </div>
    <% end %>
    <div>
      <%= form.label :title, "Issue Heading", class: "block text-sm font-semibold text-gray-700" %>
      <%= form.text_field :title, class: [
        "mt-2 block w-full rounded-sm border px-4 py-2 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition",
        issue.errors[:title].any? ? "border-red-500" : "border-gray-300"
      ] %>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :assigned_to, "Assigned To", class: "block mb-2 text-sm font-medium text-gray-900" %>
      <%= form.select :assigned_to, 
            options_for_select(
              @users.map { |u| [u.name, u.id] }, 
              issue.assigned_to.to_i.presence # ensures integer and nil-safe
            ), 
            { prompt: "Select a user" }, 
            class: [
              "bg-gray-50 border text-gray-900 text-sm rounded-lg block w-full p-2.5 pr-8",
              "focus:ring-blue-500 focus:border-blue-500",
              issue.errors[:assigned_to].any? ? "border-red-500" : "border-gray-300"
            ] %>
    </div>

    <div>
      <%= form.label :status, "Status", class: "block mb-2 text-sm font-medium text-gray-900" %>
      <%= form.select :status, 
          options_for_select(
            Issue.statuses.keys.map { |k| [k.humanize, k] }, 
            issue.status
          ), 
          {}, 
          class: [
            "bg-gray-50 border text-gray-900 text-sm rounded-lg block w-full p-2.5 pr-8",
            "focus:ring-blue-500 focus:border-blue-500",
            issue.errors[:status].any? ? "border-red-500" : "border-gray-300"
          ] %>
    </div>
  </div>

  <div>
    <%= form.label :description, "Description", class: "block text-sm font-semibold text-gray-700" %>
    <%= form.text_area :description, rows: 5, class: [
      "mt-2 block w-full rounded-sm border px-4 py-2 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition resize-none",
      issue.errors[:description].any? ? "border-red-500" : "border-gray-300"
    ] %>
  </div>

  <div class="flex justify-end gap-4">
    <% if issue.persisted? %>
      <%= link_to "Back to Project", project_path(@issue.project),
            class: "text-center rounded-sm px-4 py-2 border-2 border-blue-600 text-blue-500 font-semibold shadow-sm transition hover:bg-blue-600 hover:text-white" %>
    <% end %>

    <%= form.submit(issue.new_record? ? "Create Issue" : "Update Issue",
          class: "px-6 py-3 rounded-sm bg-indigo-600 hover:bg-indigo-700 text-white font-semibold shadow-md transition transform hover:-translate-y-0.5") %>
  </div>

<% end %>
